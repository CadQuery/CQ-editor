trigger:
  branches:
    include:
      - master
      - refs/tags/*

pr:
- master

resources:
  repositories:
    - repository: templates
      type: github
      name: CadQuery/conda-packages
      endpoint: CadQuery

parameters:
  - name: minor
    type: object
    default:
      - 11

stages:
- stage: build_conda_package
  jobs:
  - ${{ each minor in parameters.minor }}:
    - template: conda-build.yml@templates
      parameters:
        name: Linux
        vmImage: 'ubuntu-latest'
        py_maj: 3
        py_min: ${{minor}}
        conda_bld: 3.21.6

- stage: build_installers
  jobs:
  - template: constructor-build.yml@templates
    parameters:
      name: linux
      vmImage: 'ubuntu-latest'
  - template: constructor-build.yml@templates
    parameters:
      name: win
      vmImage: 'windows-latest'
  - template: constructor-build.yml@templates
    parameters:
      name: macos
      vmImage: 'macOS-latest'

- stage: upload_installers
  jobs:
  - job: upload_to_wiki
    pool:
      vmImage: ubuntu-latest
    steps:
    - download: current
      artifact: installer_ubuntu-latest
    - download: current
      artifact: installer_windows-latest
    - download: current
      artifact: installer_macOS-latest
    - bash: |
        git clone https://github.com/CadQuery/CQ-editor.wiki.git && \
        ls && \
        ls $(Pipeline.Workspace) && \
        cp $(Pipeline.Workspace)/installer*/*.* CQ-editor.wiki && \
        cd CQ-editor.wiki && \
        git add *.exe *.sh && \
        git commit -m"" && \
        git push

